<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Credit Risk Scoring - PDI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/static/css/style.css" />
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1>Credit Risk Scoring</h1>
        <p class="subtitle">PDI – credit-g (OpenML) • Logistic Regression baseline</p>
      </header>

      {% if error %}
      <div class="alert alert-error">
        <strong>Erreur :</strong> {{ error }}
        {% if details %}
        <pre class="details">{{ details | tojson(indent=2) }}</pre>
        {% endif %}
      </div>
      {% endif %}

      {% if result %}
      <div class="alert alert-success">
        <div class="grid">
          <div>
            <div class="kpi-title">Prédiction</div>
            <div class="kpi-value">{{ result.label | upper }}</div>
          </div>
          <div>
            <div class="kpi-title">Risque</div>
            <div class="kpi-value risk {{ result.risk_level }}">{{ result.risk_level | upper }}</div>
          </div>
          <div>
            <div class="kpi-title">P(bad)</div>
            <div class="kpi-value">{{ "%.3f"|format(result.probability_bad) }}</div>
          </div>
          <div>
            <div class="kpi-title">P(good)</div>
            <div class="kpi-value">{{ "%.3f"|format(result.probability_good) }}</div>
          </div>
          <div>
            <div class="kpi-title">Décision métier</div>
            <div class="kpi-value decision {{ result.business_decision }}">
              {{ result.business_decision | upper }}
            </div>
          </div>
          <div>
            <div class="kpi-title">Seuil</div>
            <div class="kpi-value">{{ "%.2f"|format(result.threshold) }}</div>
          </div>
        </div>

        <div class="badges">
          <span class="pill {{ result.risk_level }}">RISK: {{ result.risk_level | upper }}</span>
          <span class="pill decision {{ result.business_decision }}">DECISION: {{ result.business_decision | upper }}</span>
          <span class="pill neutral">THRESHOLD: {{ "%.0f"|format(result.threshold * 100) }}%</span>
        </div>

        <p class="explain">
          Décision métier : <strong>{{ result.business_decision | upper }}</strong>
          car <strong>P(bad)={{ "%.1f"|format(result.probability_bad * 100) }}%</strong>
          {% if result.probability_bad >= result.threshold %}
            est ≥
          {% else %}
            est &lt;
          {% endif %}
          <strong>seuil={{ "%.0f"|format(result.threshold * 100) }}%</strong>.
        </p>

        <div class="gauge-card card subcard">
          <h3>Score (P(bad))</h3>

          <div class="gauge-wrap">
            <div
              class="gauge risk-{{ result.risk_level }}"
              style="--p: {{ (result.probability_bad * 100) | round(1) }}; --t: {{ (result.threshold * 100) | round(1) }};"
            >
              <div class="gauge-inner">
                <div class="gauge-value">{{ "%.0f"|format(result.probability_bad * 100) }}%</div>
                <div class="gauge-label">P(bad)</div>
              </div>
            </div>

            <div class="gauge-legend">
              <div><span class="dot risk-{{ result.risk_level }}"></span> Risque (bad)</div>
              <div><span class="dot threshold"></span> Seuil métier</div>
            </div>
          </div>
        </div>

        <div class="bars card subcard">
          <h3>Probabilités</h3>

          <div class="bar-block">
            <div class="bar-head">
              <span><strong>P(bad)</strong> – risque de défaut</span>
              <span>{{ "%.1f"|format(result.probability_bad * 100) }}%</span>
            </div>
            <div class="bar-track">
              <div class="bar-fill bad risk-{{ result.risk_level }}"
              style="width: {{ (result.probability_bad * 100) | round(1) }}%;">
            </div>

            </div>

            {% if result.threshold is not none %}
            <div class="threshold-line" style="left: {{ (result.threshold * 100) | round(1) }}%;">
              <span class="threshold-label">Seuil {{ "%.0f"|format(result.threshold * 100) }}%</span>
            </div>
            {% endif %}
          </div>

          <div class="bar-block">
            <div class="bar-head">
              <span><strong>P(good)</strong> – solvabilité</span>
              <span>{{ "%.1f"|format(result.probability_good * 100) }}%</span>
            </div>
            <div class="bar-track">
              <div class="bar-fill good" style="width: {{ (result.probability_good * 100) | round(1) }}%;"></div>
            </div>
          </div>

          <p class="note">
            Lecture : plus la barre <strong>P(bad)</strong> est longue, plus le risque est élevé.
            La ligne “Seuil” illustre la règle métier (rejet si P(bad) ≥ seuil).
          </p>
        </div>

        <p class="note">
          *Les seuils de risque (low/medium/high) sont basés sur P(bad) et peuvent être ajustés.
        </p>
      </div>
      {% endif %}

      <div class="demo-actions">
        <a href="/demo/low" class="btn-secondary">Démo LOW</a>
        <a href="/demo/medium" class="btn-secondary">Démo MEDIUM</a>
        <a href="/demo/high" class="btn-secondary">Démo HIGH</a>
      </div>


      <form class="card" method="post" action="/ui/predict">
        <h2>Informations client</h2>

        <div class="form-grid">
          <!-- Numériques -->
          <label>
            Duration (months)
            <input type="number" name="duration" min="1" required value="{{ form.duration if form else 24 }}" />
          </label>

          <label>
            Credit amount
            <input type="number" name="credit_amount" min="1" step="1" required value="{{ form.credit_amount if form else 5000 }}" />
          </label>

          <label>
            Installment commitment (1–4)
            <input type="number" name="installment_commitment" min="1" max="4" required value="{{ form.installment_commitment if form else 3 }}" />
          </label>

          <label>
            Residence since (1–4)
            <input type="number" name="residence_since" min="1" max="4" required value="{{ form.residence_since if form else 4 }}" />
          </label>

          <label>
            Age
            <input type="number" name="age" min="18" max="120" required value="{{ form.age if form else 45 }}" />
          </label>

          <label>
            Existing credits
            <input type="number" name="existing_credits" min="0" max="10" required value="{{ form.existing_credits if form else 2 }}" />
          </label>

          <label>
            Num dependents
            <input type="number" name="num_dependents" min="0" max="10" required value="{{ form.num_dependents if form else 1 }}" />
          </label>

          <!-- Catégorielles (texte libre pour le PDI; handle_unknown="ignore") -->
          <label>
            Checking status
            <select name="checking_status" required>
              {% for option in categorical_options.checking_status %}
                <option value="{{ option }}"
                  {% if form and form.checking_status == option %}selected{% endif %}>
                  {{ option }}
                </option>
              {% endfor %}
            </select>
          </label>

          <label>
            Credit history
            <select name="credit_history" required>
              {% for option in categorical_options.credit_history %}
                <option value="{{ option }}"
                  {% if form and form.credit_history == option %}selected{% endif %}>
                  {{ option }}
                </option>
              {% endfor %}
            </select>
          </label>

          <label>
            Purpose
            <select name="purpose" required>
              {% for option in categorical_options.purpose %}
                <option value="{{ option }}"
                  {% if form and form.purpose == option %}selected{% endif %}>
                  {{ option }}
                </option>
              {% endfor %}
            </select>
          </label>

          <label>
            Savings status
            <select name="savings_status" required>
              {% for option in categorical_options.savings_status %}
                <option value="{{ option }}"
                  {% if form and form.savings_status == option %}selected{% endif %}>
                  {{ option }}
                </option>
              {% endfor %}
            </select>
          </label>

          <label>
            Employment
            <select name="employment" required>
              {% for option in categorical_options.employment %}
                <option value="{{ option }}"
                  {% if form and form.employment == option %}selected{% endif %}>
                  {{ option }}
                </option>
              {% endfor %}
            </select>
          </label>

          <label>
            Personal status
            <select name="personal_status" required>
              {% for option in categorical_options.personal_status %}
                <option value="{{ option }}"
                  {% if form and form.personal_status == option %}selected{% endif %}>
                  {{ option }}
                </option>
              {% endfor %}
            </select>
          </label>

          <label>
            Other parties
            <select name="other_parties" required>
              {% for option in categorical_options.other_parties %}
                <option value="{{ option }}"
                  {% if form and form.other_parties == option %}selected{% endif %}>
                  {{ option }}
                </option>
              {% endfor %}
            </select>
          </label>

          <label>
            Property magnitude
            <select name="property_magnitude" required>
              {% for option in categorical_options.property_magnitude %}
                <option value="{{ option }}"
                  {% if form and form.property_magnitude == option %}selected{% endif %}>
                  {{ option }}
                </option>
              {% endfor %}
            </select>
          </label>

          <label>
            Other payment plans
            <select name="other_payment_plans" required>
              {% for option in categorical_options.other_payment_plans %}
                <option value="{{ option }}"
                  {% if form and form.other_payment_plans == option %}selected{% endif %}>
                  {{ option }}
                </option>
              {% endfor %}
            </select>
          </label>

          <label>
            Housing
            <select name="housing" required>
              {% for option in categorical_options.housing %}
                <option value="{{ option }}"
                  {% if form and form.housing == option %}selected{% endif %}>
                  {{ option }}
                </option>
              {% endfor %}
            </select>
          </label>

          <label>
            Job
            <select name="job" required>
              {% for option in categorical_options.job %}
                <option value="{{ option }}"
                  {% if form and form.job == option %}selected{% endif %}>
                  {{ option }}
                </option>
              {% endfor %}
            </select>
          </label>

          <label>
            Own telephone
            <select name="own_telephone" required>
              {% for option in categorical_options.own_telephone %}
                <option value="{{ option }}"
                  {% if form and form.own_telephone == option %}selected{% endif %}>
                  {{ option }}
                </option>
              {% endfor %}
            </select>
          </label>

          <label>
            Foreign worker
            <select name="foreign_worker" required>
              {% for option in categorical_options.foreign_worker %}
                <option value="{{ option }}"
                  {% if form and form.foreign_worker == option %}selected{% endif %}>
                  {{ option }}
                </option>
              {% endfor %}
            </select>
          </label>
        </div>

        <div class="card subcard">
          <h3>Seuil métier</h3>

          <label>
            Seuil de rejet (P(bad) ≥ seuil)
            <input
              type="range"
              name="threshold"
              min="0"
              max="1"
              step="0.01"
              value="{{ form.threshold if form and form.threshold is not none else 0.5 }}"
              oninput="document.getElementById('thresholdValue').textContent = this.value"
            />
            <div class="slider-row">
              <span>0.00</span>
              <strong id="thresholdValue">
                {{ form.threshold if form and form.threshold is not none else 0.5 }}
              </strong>
              <span>1.00</span>
            </div>
          </label>

          <p class="hint">
            Plus le seuil est bas, plus on rejette de dossiers (réduction du risque, mais plus de faux positifs).
            Plus le seuil est haut, plus on accepte (meilleure conversion, mais plus de risque).
          </p>
        </div>

        <div class="actions">
          <button type="submit">Scorer</button>
          <a class="btn-secondary" href="/">Réinitialiser</a>
        </div>

      </form>

      <footer class="footer">
        <small>© PDI – pdi-credit-risk-ml</small>
      </footer>
    </div>
  </body>
</html>
